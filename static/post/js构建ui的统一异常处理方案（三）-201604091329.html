<!doctype html><head><meta charset="utf-8"><style>.mydoc{font-size:14px;overflow:hidden}.mydoc_blockquote{padding:12px 5px 12px 30px;margin:2em 0 0 8px;border-width:0;border-left:4px solid #f66;background-color:#f8f8f8;position:relative;border-bottom-right-radius:2px;border-top-right-radius:2px;line-height:1.6em}.mydoc_blockquote:before{position:absolute;top:14px;left:-12px;background-color:#f66;color:#fff;content:"!";width:20px;height:20px;text-align:center;line-height:20px;font-weight:700;font-family:Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:14px;border-radius:10px}code[class*=language-],pre[class*=language-]{color:#000;background:none;text-shadow:0 1px #fff;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::-moz-selection,code[class*=language-] ::-moz-selection,pre[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection{text-shadow:none;background:#b3d4fc}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{text-shadow:none;background:#b3d4fc}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{color:#a67f59;background:hsla(0,0%,100%,.5)}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.mydoc_code{overflow-x:auto;position:relative;background-color:#f8f8f8;padding:0;line-height:1.1em;border-radius:2px;margin:1.2em 0;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AgMAAABHkjHhAAAACVBMVEWAgIBaWlo+Pj7rTFvWAAAAA3RSTlMHCAw+VhR4AAAA+klEQVQoz4WSMW7EQAhFPxKWNh2FCx+HkaZI6RRb5DYbyVfIJXLKDCFoMbaTKSw/8ZnPAPjaH2xgZcUNUDADD7D9LtDBCLZ45fbkvo/30K8yeI64pPwl6znd/3n/Oe93P3ho9qeh72btTFzqkz0rsJle8Zr81OLEwZ1dv/713uWqvu2pl+k0fy7MWtj9r/tN5q/02z89qa/L4Dc2LvM93kezPfXlME/O86EbY/V9GB9ePX8G1/6W+/9h1dq/HGfTfzT3j/xNo7522Bfnqe5jO/fvhVthlfk434v3iO9zG/UOphyPeinPl1J8Gtaa7xPTa/Dk+RIs4deMvwGvcGsmsCvJ0AAAAABJRU5ErkJggg==")}.mydoc_code_pre{padding:1.2em 1.4em;line-height:1.5em;margin:0}.mydoc_h1{margin:0 0 1em}.mydoc_h1_a{color:#2c3e50;text-decoration:none;font-size:2em}.mydoc_h1_h1{margin:45px 0 8px;padding-bottom:7px;font-size:28px}.mydoc_h2{margin:35px 0 .8em}.mydoc_h2_a{font-size:1.5em;text-decoration:none;color:#2c3e50}.mydoc_h2_a:before{content:"";display:block;margin-top:-40px;height:40px;visibility:hidden}.mydoc_h2_h2{margin:5px 0 8px;border-bottom:1px solid #ddd;font-size:22px;padding-bottom:1em}.mydoc_h3{margin:35px 0 .8em}.mydoc_h3_a{font-size:1.3em;text-decoration:none;color:#2c3e50}.mydoc_h3_a:before{content:"";display:block;margin-top:-30px;height:30px;visibility:hidden}.mydoc_h3_h3{margin:5px 0 8px;border-bottom:1px solid #ddd;font-size:18px;padding-bottom:.6em}.mydoc_h4{margin:35px 0 .8em}.mydoc_h4_a{font-size:1.2em;text-decoration:none;color:#2c3e50}.mydoc_h4_a:before{content:"";display:block;margin-top:-20px;height:20px;visibility:hidden}.mydoc_h4_h4{margin:5px 0 8px;border-bottom:1px solid #ddd;font-size:16px;padding-bottom:.3em}.mydoc_table{margin:15px 0 0;padding:0;border:1px solid #aaa;border-collapse:collapse;width:100%;color:#000;font-size:14px;background-color:#fdfcf8}.mydoc_table .mydoc_tr{margin:0;padding:0;border:0;background-color:#fff}.mydoc_table .mydoc_tr:nth-child(odd){background-color:#f5f5f5}.mydoc_table .mydoc_th,.mydoc_table .mydoc_tr:first-child{background-color:#3f3f3f}.mydoc_table .mydoc_th{margin:0;padding:5px 15px 5px 6px;border:1px solid #3f3f3f;vertical-align:baseline;text-align:left;color:#fff;width:123px;word-break:break-all;font-weight:400}.mydoc_table .mydoc_td{word-break:break-all;margin:0;padding:6px 15px 6px 6px;border:1px solid #aaa;vertical-align:text-top}.mydoc_img{display:block;max-width:100%}.mydoc_li:first-child,:not(.mydoc_li)+.mydoc_li{margin-top:10px}.mydoc_li+.mydoc_li{margin-top:-10px}.mydoc_li{margin:0;color:#34495e;margin-bottom:10px;position:relative}.mydoc_p{line-height:1.6em;margin:1.2em 0 -1.2em;padding-bottom:1.2em;position:relative;z-index:1;color:#333}.mydoc_a{color:#42b983;font-weight:400;text-decoration:none;cursor:pointer}.mydoc_strong{font-weight:600;color:#2c3e50}</style></head><article class='mydoc'>
                    <div class="mydoc_h1">
                <a class="mydoc_h1_a">
                    <h1 class="mydoc_h1_h1">js构建ui的统一异常处理方案（三）</h1>
                </a>
                <div class="mydoc_h1_content">
                    <p class="mydoc_p"> 笔者之前分析了如何实现js的责任链异常处理的方法，通过promise这个异步模型，我们能够对同步方法和异步方法的两种情况，均可以实现责任链模式。有了这些武器，我们就可以开始设计ui的统一异常处理方案了。</p><div class="mydoc_h2">
                    <a class="mydoc_h2_a">
                        <h2 class="mydoc_h2_h2">1.统一异常处理方案</h2>
                    </a>
                    <div class="mydoc_h1_content">
                        <p class="mydoc_p"> 这里所谓统一异常处理方案，其实就是指对那些底层无法处理的，一层层抛到了边界类的异常，在边界类中根据异常的不同类型，做出不同处理方案的处理策略。为了能在边界类中对异常类型做出判断，我们需要将常用的异常类型定义出来，再将原始异常包装为这些系统内部定义的异常类型。所以，整个统一处理方案的需求大致有如下几点：</p><p class="mydoc_p"> 这种统一处理异常的方案，我们在服务器端开发经常用到的，客户端往往不需要实现这种复杂的异常处理方案。但是随着前后台完全解耦，尤其是spa应用的但是，前端现在越来越复杂。而系统复杂的同时，出现异常的概率和异常处理的难度也在增加，所以统一异常处理同样适于用客户端，即我们的ui页面。</p>
                    </div>
                </div><div class="mydoc_h2">
                    <a class="mydoc_h2_a">
                        <h2 class="mydoc_h2_h2">2.统一的ui异常处理方案</h2>
                    </a>
                    <div class="mydoc_h1_content">
                        <p class="mydoc_p"> 如果后端的异常处理核心是记录日志，那么ui的异常处理核心在于向用户响应。不同的错误给用户的响应也应该是不一样的，我们需要分析出常出现的异常，并为其设计出处理策略，这才是ui异常处理方案的核心。</p><p class="mydoc_p"> 对于客户端（即ui）来说，通常是采取mvc模式设计的，或者是近来开始流行的mvvm。无论是哪一种，都有controllor的概念，controllor注意需要完成两个任务：</p><p class="mydoc_p"> 1.初始化ui：这个过程一旦出现异常，整个ui的业务逻辑都无法正常进行。处理起来往往比较棘手，通常是返回之前的ui或者是直接退出系统都有可能。</p><p class="mydoc_p"> 2.响应视图控件的事件：通常在事件中，通过调用底层提供的service方法，和后台服务器异步请求，或者本身就是完成一个前端交互动作（例如点击按钮，弹出一个对话框）。如果是前端交互动作通常是一个事件衔接另一个事件，一旦一个事件出现异常往往很难难有合适的处理方案。但是，如果把这些事件看成是一个异步方法就衔接起来就简单多了，只在第一个用户事件中视为调用的发起者，后续操作均看成是异步调用。</p><p class="mydoc_p"> 所以，需要统一做异常处理的地方，就是controllor执行页面初始化的过程，以及controllor对一个用户用例过程中的第一个事件。</p><p class="mydoc_p"> 同时我们还需分析一下我们需要封装哪些系统异常，因为我们需要根据其类型做出不同策略的异常处理方案的。常见的系统异常应有如下几种：</p><p class="mydoc_p"> 基本上这些异常便可以满足绝大多数客户端的需求。</p>
                    </div>
                </div><div class="mydoc_h2">
                    <a class="mydoc_h2_a">
                        <h2 class="mydoc_h2_h2">3.和客户端应用的集成</h2>
                    </a>
                    <div class="mydoc_h1_content">
                        <p class="mydoc_p"> 统一异常处理从他的复杂程度就能看出，只用复杂的应用才需要使用这种方案，因此我们的页面必须是富客户端的应用，最好是spa的应用。spa应用指的是单页 Web 应用 (single-page application) ，即不会因为用户的操作而进行页面的重新加载或跳转，而是利用 JavaScript 动态的变换HTML的内容，从而实现UI与用户的交互。由于避免了页面的重新加载的web页面，这种应用的复杂程度远高于传统web页面。所以这种应用最适合采用统一的异常处理方案。</p><p class="mydoc_p"> 同时应用也应该是采取mvc（mvvm）的设计模式，能够将视图逻辑和系统业务很好的分离开来。另外系统的业务部分以及和服务器请求的部分尽量从controllor中分离出来，封装成service层，这样可以更加增加维护性并且可以实现复用，相同业务的代码尽量只写一遍。如果没有统一异常处理方案，这种分层的异常处理实现起来是非常困难的，而使用了统一异常处理，每一层只需要考虑他们自己应该做的事情，实现这种前端分层成了可能。</p><p class="mydoc_p"> 同时因为异步方法的存在，所以我们的service需要是使用promise将其封装的，每个方法最好通过名称就能看出他是异步的还是同步的。当一个方法我们无法确定他是异步还是同步的时候，我们应优先用promise封装，因为同步代码转变为异步比较容易，而异步代码是无法转变为同步代码的。</p><p class="mydoc_p"> 最后就是具体设计和代码实现了，请见下一章节。</p>
                    </div>
                </div>
                </div>
            </div>
                </article>